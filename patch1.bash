#!/bin/bash

# global variables
declare -r THIS_SCRIPT_DIR="$(cd -- "$(dirname "$0")" >/dev/null 2>&1; pwd -P)"

. $THIS_SCRIPT_DIR/common.bash

run_query '
    DROP TABLE IF EXISTS AUTHOR_EXPERIENCE_ORIGINAL;
'

run_query '
    ALTER TABLE AUTHOR_EXPERIENCE
      RENAME TO AUTHOR_EXPERIENCE_ORIGINAL;
'

run_query '
    CREATE TABLE IF NOT EXISTS AUTHOR_EXPERIENCE (
        ISSUE_KEY                                   TEXT    NOT NULL,
        IS_FIX                                      INTEGER NOT NULL,
        AUTHOR                                      TEXT    NOT NULL,
        PROJECT_ID                                  TEXT    NOT NULL,
        SOURCE_FILE                                 TEXT    NOT NULL,
        COMMIT_HASH                                 TEXT    NOT NULL,
        COMMIT_DATE                                 TEXT    NOT NULL,
    
        ANALYSIS_KEY                                TEXT    NOT NULL,
        SQALE_INDEX                                 INTEGER NOT NULL,
        IS_FAULT_INDUCING                           INTEGER NOT NULL,
        IS_FAULT_FIXING                             INTEGER NOT NULL,

        TOTAL_HOURS_SINCE_LAST_TOUCH                INTEGER,
        TOTAL_HOURS_SINCE_FIRST_PROJECT_COMMIT      INTEGER NOT NULL,

        TOTAL_SOURCE_FILE_COMMITS                   INTEGER NOT NULL,
        TOTAL_SOURCE_FILE_LINE_ADDITIONS            INTEGER NOT NULL,
        TOTAL_SOURCE_FILE_LINE_SUBTRACTIONS         INTEGER NOT NULL,
        TOTAL_SOURCE_FILE_LINE_CHANGES              INTEGER NOT NULL,

        TOTAL_PROJECT_COMMITS                       INTEGER NOT NULL,

        TOTAL_RECENT_SOURCE_FILE_COMMITS            INTEGER NOT NULL,
        TOTAL_RECENT_SOURCE_FILE_LINE_ADDITIONS     INTEGER NOT NULL,
        TOTAL_RECENT_SOURCE_FILE_LINE_SUBTRACTIONS  INTEGER NOT NULL,
        TOTAL_RECENT_SOURCE_FILE_LINE_CHANGES       INTEGER NOT NULL,

        TOTAL_RECENT_PROJECT_COMMITS                INTEGER NOT NULL,

        AUTHOR_HOURS_SINCE_LAST_TOUCH               INTEGER,
        AUTHOR_HOURS_SINCE_FIRST_PROJECT_COMMIT     INTEGER NOT NULL,

        AUTHOR_SOURCE_FILE_COMMITS                  INTEGER NOT NULL,
        AUTHOR_SOURCE_FILE_LINE_ADDITIONS           INTEGER NOT NULL,
        AUTHOR_SOURCE_FILE_LINE_SUBTRACTIONS        INTEGER NOT NULL,
        AUTHOR_SOURCE_FILE_LINE_CHANGES             INTEGER NOT NULL,

        AUTHOR_PROJECT_COMMITS                      INTEGER NOT NULL,

        AUTHOR_RECENT_SOURCE_FILE_COMMITS           INTEGER NOT NULL,
        AUTHOR_RECENT_SOURCE_FILE_LINE_ADDITIONS    INTEGER NOT NULL,
        AUTHOR_RECENT_SOURCE_FILE_LINE_SUBTRACTIONS INTEGER NOT NULL,
        AUTHOR_RECENT_SOURCE_FILE_LINE_CHANGES      INTEGER NOT NULL,

        AUTHOR_RECENT_PROJECT_COMMITS               INTEGER NOT NULL,

        PRIMARY KEY (ISSUE_KEY, IS_FIX)
    );
'

run_query '
    INSERT OR IGNORE INTO AUTHOR_EXPERIENCE
            SELECT AUTHOR_EXPERIENCE_ORIGINAL.ISSUE_KEY,
                   AUTHOR_EXPERIENCE_ORIGINAL.IS_FIX,
                   AUTHOR_EXPERIENCE_ORIGINAL.AUTHOR,
                   AUTHOR_EXPERIENCE_ORIGINAL.PROJECT_ID,
                   AUTHOR_EXPERIENCE_ORIGINAL.SOURCE_FILE,
                   AUTHOR_EXPERIENCE_ORIGINAL.COMMIT_HASH,
                   AUTHOR_EXPERIENCE_ORIGINAL.COMMIT_DATE,
                   SONAR_ANALYSIS.ANALYSIS_KEY,
                   SONAR_MEASURES.SQALE_INDEX,
                   CASE WHEN FAULT_INDUCING_COMMITS.FAULT_INDUCING_COMMIT_HASH IS NULL
                        THEN 0
                        ELSE 1
                        END
                   AS IS_FAULT_INDUCING,
                   CASE WHEN FAULT_FIXING_COMMITS.FAULT_FIXING_COMMIT_HASH IS NULL
                        THEN 0
                        ELSE 1
                        END
                   AS IS_FAULT_FIXING,
                   AUTHOR_EXPERIENCE_ORIGINAL.TOTAL_HOURS_SINCE_LAST_TOUCH,
                   AUTHOR_EXPERIENCE_ORIGINAL.TOTAL_HOURS_SINCE_FIRST_PROJECT_COMMIT,
                   AUTHOR_EXPERIENCE_ORIGINAL.TOTAL_SOURCE_FILE_COMMITS,
                   AUTHOR_EXPERIENCE_ORIGINAL.TOTAL_SOURCE_FILE_LINE_ADDITIONS,
                   AUTHOR_EXPERIENCE_ORIGINAL.TOTAL_SOURCE_FILE_LINE_SUBTRACTIONS,
                   AUTHOR_EXPERIENCE_ORIGINAL.TOTAL_SOURCE_FILE_LINE_CHANGES,
                   AUTHOR_EXPERIENCE_ORIGINAL.TOTAL_PROJECT_COMMITS,
                   AUTHOR_EXPERIENCE_ORIGINAL.TOTAL_RECENT_SOURCE_FILE_COMMITS,
                   AUTHOR_EXPERIENCE_ORIGINAL.TOTAL_RECENT_SOURCE_FILE_LINE_ADDITIONS,
                   AUTHOR_EXPERIENCE_ORIGINAL.TOTAL_RECENT_SOURCE_FILE_LINE_SUBTRACTIONS,
                   AUTHOR_EXPERIENCE_ORIGINAL.TOTAL_RECENT_SOURCE_FILE_LINE_CHANGES,
                   AUTHOR_EXPERIENCE_ORIGINAL.TOTAL_RECENT_PROJECT_COMMITS,
                   AUTHOR_EXPERIENCE_ORIGINAL.AUTHOR_HOURS_SINCE_LAST_TOUCH,
                   AUTHOR_EXPERIENCE_ORIGINAL.AUTHOR_HOURS_SINCE_FIRST_PROJECT_COMMIT,
                   AUTHOR_EXPERIENCE_ORIGINAL.AUTHOR_SOURCE_FILE_COMMITS,
                   AUTHOR_EXPERIENCE_ORIGINAL.AUTHOR_SOURCE_FILE_LINE_ADDITIONS,
                   AUTHOR_EXPERIENCE_ORIGINAL.AUTHOR_SOURCE_FILE_LINE_SUBTRACTIONS,
                   AUTHOR_EXPERIENCE_ORIGINAL.AUTHOR_SOURCE_FILE_LINE_CHANGES,
                   AUTHOR_EXPERIENCE_ORIGINAL.AUTHOR_PROJECT_COMMITS,
                   AUTHOR_EXPERIENCE_ORIGINAL.AUTHOR_RECENT_SOURCE_FILE_COMMITS,
                   AUTHOR_EXPERIENCE_ORIGINAL.AUTHOR_RECENT_SOURCE_FILE_LINE_ADDITIONS,
                   AUTHOR_EXPERIENCE_ORIGINAL.AUTHOR_RECENT_SOURCE_FILE_LINE_SUBTRACTIONS,
                   AUTHOR_EXPERIENCE_ORIGINAL.AUTHOR_RECENT_SOURCE_FILE_LINE_CHANGES,
                   AUTHOR_EXPERIENCE_ORIGINAL.AUTHOR_RECENT_PROJECT_COMMITS
              FROM AUTHOR_EXPERIENCE_ORIGINAL
        INNER JOIN SONAR_ANALYSIS
                ON (SONAR_ANALYSIS.PROJECT_ID = AUTHOR_EXPERIENCE_ORIGINAL.PROJECT_ID AND
                    SONAR_ANALYSIS.REVISION   = AUTHOR_EXPERIENCE_ORIGINAL.COMMIT_HASH)
        INNER JOIN SONAR_MEASURES
                ON (SONAR_MEASURES.PROJECT_ID   = AUTHOR_EXPERIENCE_ORIGINAL.PROJECT_ID AND
                    SONAR_MEASURES.ANALYSIS_KEY = SONAR_ANALYSIS.ANALYSIS_KEY)
         LEFT JOIN SZZ_FAULT_INDUCING_COMMITS  FAULT_INDUCING_COMMITS
                ON (FAULT_INDUCING_COMMITS.PROJECT_ID                 = AUTHOR_EXPERIENCE_ORIGINAL.PROJECT_ID AND
                    FAULT_INDUCING_COMMITS.FAULT_INDUCING_COMMIT_HASH = AUTHOR_EXPERIENCE_ORIGINAL.COMMIT_HASH)
         LEFT JOIN SZZ_FAULT_INDUCING_COMMITS  FAULT_FIXING_COMMITS
                ON (FAULT_FIXING_COMMITS.PROJECT_ID               = AUTHOR_EXPERIENCE_ORIGINAL.PROJECT_ID AND
                    FAULT_FIXING_COMMITS.FAULT_FIXING_COMMIT_HASH = AUTHOR_EXPERIENCE_ORIGINAL.COMMIT_HASH);
'

run_query '
    DROP TABLE AUTHOR_EXPERIENCE_ORIGINAL;
'
